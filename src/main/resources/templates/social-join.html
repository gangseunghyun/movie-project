<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>추가 정보 입력</title>
    <style>
        body { background: #f5f6fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 400px; margin: 60px auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); padding: 2rem; }
        h2 { text-align: center; margin-bottom: 1.5rem; color: #333; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #333; font-weight: 500; }
        .form-group input { width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem; }
        .btn { width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .btn:hover { background: #667eea; }
        .error-message { color: #e74c3c; font-size: 0.9rem; margin-top: 0.25rem; }
        .success-message { color: #27ae60; font-size: 0.9rem; margin-top: 0.25rem; }
        .terms-section {
            margin: 10px 0 0 0;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 1rem;
            cursor: pointer;
            user-select: none;
            min-height: 32px;
        }
        .checkbox-label input[type="checkbox"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            accent-color: #667eea;
            vertical-align: middle;
        }
        .checkbox-label span {
            flex: none;
            line-height: 1.5;
            margin-right: 8px;
        }
        .terms-link {
            margin-left: 8px;
            color: #667eea;
            text-decoration: underline;
            font-size: 0.97em;
            cursor: pointer;
            line-height: 1.5;
            vertical-align: middle;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>추가 정보 입력</h2>
    <form id="socialJoinForm" method="post" action="/social-join" th:action="@{/social-join}">
        <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->
        <div class="form-group">
            <label for="nickname">닉네임</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="text" id="nickname" name="nickname" required placeholder="닉네임 입력" style="flex: 1;">
                <button type="button" id="recommendNicknameBtn" class="btn" style="width: auto; padding: 0.5rem 1rem; background: #27ae60;">닉네임 추천</button>
            </div>
            <div class="error-message" id="nicknameError"></div>
            <div class="success-message" id="nicknameSuccess"></div>
        </div>
        <div class="form-group" id="termsGroup">
            <label style="font-weight: bold;">약관 동의</label>
            <div class="terms-section">
                <label class="checkbox-label">
                    <input type="checkbox" id="termsAll">
                    <span style="font-weight:600; color:#333;">전체 동의</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="termsService" name="termsService" required>
                    <span>[필수] 서비스 이용약관 동의</span>
                    <a href="/terms/service" target="_blank" class="terms-link">보기</a>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="termsPrivacy" name="termsPrivacy" required>
                    <span>[필수] 개인정보 처리방침 동의</span>
                    <a href="/terms/privacy" target="_blank" class="terms-link">보기</a>
                </label>
            </div>
            <div class="error-message" id="termsError" style="display:none;"></div>
        </div>
        <button type="submit" class="btn">회원가입 완료</button>
    </form>
</div>
<script>
// 닉네임 중복 확인/추천 JS (join.html과 동일하게 적용)
const nicknameInput = document.getElementById('nickname');
const nicknameError = document.getElementById('nicknameError');
const nicknameSuccess = document.getElementById('nicknameSuccess');
const recommendNicknameBtn = document.getElementById('recommendNicknameBtn');

async function checkNicknameDuplicate(nickname) {
    try {
        const response = await fetch(`/api/users/check-nickname?nickname=${encodeURIComponent(nickname)}`);
        const data = await response.json();
        return data.duplicate;
    } catch (error) {
        return false;
    }
}

async function getRecommendedNicknames() {
    try {
        const response = await fetch('/api/users/recommend-nickname');
        const data = await response.json();
        return data.nicknames || [];
    } catch (error) {
        return [];
    }
}

nicknameInput.addEventListener('input', async function() {
    const nickname = this.value.trim();
    if (!nickname) {
        nicknameError.textContent = '닉네임을 입력해주세요.';
        nicknameError.style.display = 'block';
        nicknameSuccess.style.display = 'none';
        this.classList.remove('success');
        this.classList.add('error');
        return;
    }
    const isDuplicate = await checkNicknameDuplicate(nickname);
    if (isDuplicate) {
        nicknameError.textContent = '이미 사용 중인 닉네임입니다.';
        nicknameError.style.display = 'block';
        nicknameSuccess.style.display = 'none';
        this.classList.remove('success');
        this.classList.add('error');
    } else {
        nicknameError.style.display = 'none';
        nicknameSuccess.textContent = '✓ 사용 가능한 닉네임입니다.';
        nicknameSuccess.style.display = 'block';
        this.classList.remove('error');
        this.classList.add('success');
    }
});

recommendNicknameBtn.addEventListener('click', async function() {
    recommendNicknameBtn.disabled = true;
    recommendNicknameBtn.textContent = '추천 중...';
    const nicknames = await getRecommendedNicknames();
    if (nicknames.length > 0) {
        const nickname = nicknames[Math.floor(Math.random() * nicknames.length)];
        nicknameInput.value = nickname;
        nicknameInput.dispatchEvent(new Event('input'));
    } else {
        nicknameError.textContent = '추천 닉네임을 가져오지 못했습니다.';
        nicknameError.style.display = 'block';
        nicknameSuccess.style.display = 'none';
    }
    recommendNicknameBtn.disabled = false;
    recommendNicknameBtn.textContent = '닉네임 추천';
});

// 약관 동의 체크
const termsService = document.getElementById('termsService');
const termsPrivacy = document.getElementById('termsPrivacy');
const termsAll = document.getElementById('termsAll');
const termsError = document.getElementById('termsError');
const form = document.getElementById('socialJoinForm');
form.addEventListener('submit', function(e) {
    if (!termsService.checked || !termsPrivacy.checked) {
        e.preventDefault();
        termsError.textContent = '필수 약관에 모두 동의해야 회원가입이 가능합니다.';
        termsError.style.display = 'block';
    } else {
        termsError.style.display = 'none';
    }
});

// 전체 동의 체크박스 동기화
termsAll.addEventListener('change', function() {
    termsService.checked = this.checked;
    termsPrivacy.checked = this.checked;
});

[termsService, termsPrivacy].forEach(cb => {
    cb.addEventListener('change', function() {
        termsAll.checked = termsService.checked && termsPrivacy.checked;
    });
});

document.addEventListener('DOMContentLoaded', function() {
    // 뒤로가기/새로고침 시 쿼리스트링 제거
    if (window.location.search) {
        history.replaceState(null, '', window.location.pathname);
    }
    // 입력 시 alert/메시지 숨김
    var alertDiv = document.querySelector('.alert.alert-error');
    var msgDiv = document.querySelector('.alert.alert-success');
    var nicknameInput = document.getElementById('nickname');
    if (nicknameInput) {
        nicknameInput.addEventListener('input', function() {
            if (alertDiv) alertDiv.style.display = 'none';
            if (msgDiv) msgDiv.style.display = 'none';
        });
    }
});
</script>
</body>
</html> 